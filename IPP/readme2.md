# Implementační dokumentace k 2. úloze do IPP 2019/2020
 - Jméno a přijmení: Petr Dančák
 - Login: xdanca01

## IPP - test.php
 - První činnost skriptu je inicializace globálních proměnných, ve kterých jsou uloženy cesty k pomocným souborům, pro správný výpis HTML formátu na stdout, dále se inicializují globální proměnné obsahující nastavení prostředí, pro správný přístup k testovacím sktriptům a utilitám, které mají defaultní nastavení podle zadání. Pak se deklarují a inicializují countery, které obsahují počty neúspěšných, úspěšných testů a celkový počet testů.
 - Po nastavení prostředí, se kontroluje existence skriptů a pomocných souborů. Pokud se všechny soubory naleznou, tak se vypíše výsledná hlavička HTML souboru na stdout a přejde se do for cyklu, který prochází všechny výskyty souborů s příponou '.src' nalezené pomocí utility 'find' v shellu. Každý jeden cyklus si nastaví správná jména souborů ke každému testu a zkontroluje, že danné soubory existují. Pokud ne tak se vytvoří s defaultními hodnotami a ke konci pomocí shell 'rm' utility smažou.
 - Jakmile je všechno tohle v každém cyklu nastaveno, tak se přejde do jedné ze tří částí a to buď both, int-only a nebo parse-only. Podle typu částí se provede spuštění v shellu s nastavenými parametry. V části both se nejdříve spustí php skript 'parse.php' a jeho výstup se uloží do dočasného souboru, který se dále buď pošle do interpretu a nebo ukončí test s výsledkem FAIL, to vše záleží na návratové hodnotě shell skriptu. Podobné je to i v části parse-only, kde se spustí jen php skript 'parse.php' a zkontroluje se pomocí mé funkce 'is\_xml\_ok', do které se jako parametr vloží dočasný soubor s výstupem parseru a výsledek testového souboru s příponou '.out'. Pak je tu ještě třetí část int-only a v té se zase jen spustí 'interpret.py' zkontroluje se návratová hodnota a výstup se porovná s očekávaným výstupem pomocí shell utility 'diff'.
 - Při každém dokončení testu se zvýší hodnota čítače (counteru) s počtem neúspěšných, nebo úspěšných testů a zároveň čítač s celkovým počtem testů.
 - Ke generování výsledků testů se používá funkce 'get_HTML', které se předá jako parametr výsledek testu, jméno testu, návratová hodnota testu, předpokládaná návratová hodnota testu a barva označení řádku ve výsledném HTML formátu, která je buď zelená při úspěchu nebo červená při neúspěchu.
 - Dále pak během testování je použita 'is\_xml\_ok' funkce, která pomocí utility jexamxml zkontroluje odlišnosti v porovnávaných '.xml' souborech, předávaných pomocí argumentů.
 - Po konci cyklu se vypíše i konečná část HTML formátu na stdout.

## IPP - interpret.py
 - Program začíná definicí globálních proměnných, ve kterých je uloženo, kde se nachází source file, který je při nedefinování nastaven na stdin, cesta k souboru se vstupními daty pro instrukci 'READ', při nedefinování je nastavena na stdin, globální rámec, do kterého se uloží prázdné pole, lokální rámec, do kterého se na začátku také uloží prázdné pole, deklaruje se dočasný rámec, zásobník, do kterého se také vloží prázdné pole a nakonec se inicializuje čítač počtu zavolání instrukce 'CALL', který slouží k zjištění počtu zanoření v programu.
 - Dále se definuje funkce main, která se zavolá na konci programu. Ve funkci main se kontroluje správný zápis programu v xml formátu a následné parsování atributů do konstruktoru třídy instrukce, kterému se předá parametr order, opcode, datový typ prvního operandu pokud je, pokud ne tak null, dále pak hodnotu prvního operandu opět jen pokud je, a to samé platí pro druhý a třetí argument. V konstruktoru třídy instrukce se nad argumenty zavolá substituční funkce 'sub', která nahradí zpětné lomítko a tři číslice, za odpovídající znak. Inicializují se atributy a provede se kontrola syntaxe a sémantiky jednotlivých opcódů. Přesněji se zkontroluje velikost písmen atributu opcode, počet předaných argumentů pro jednotlivé atributy opcode a datový typ jednotlivých atributů opcode. Pokud nějaký z atributů nesedí, tak je chyba ve vstupním xml formátu a program se ukončí s návratovým kódem 32.
 - Po zápisu instrukcí do pole instrukcí se vytvoří záloha všech instrukcí, pro účely skoku a instrukce se začnou vykonávat a to tak, že se postupně prochází jednotlivé prvky pole a hledá se prvek s nejmenší hodnotou atributu order. Instrukce s nejmenší hodnotou order, se předá jako argument funkci 'instr_exec' a provede se podle danné specifikace.
 - Ve funkci 'instr\_exec' se používají pomocné funkce pro kontrolu datových typů, jako je například funkce 'is\_defined', která má návratovou hodnotu podle toho, jestli je proměnná definovaná, nebo ne. Dále se používá například funkce, která mi najde index proměnné v poli, které reprezentuje frame. Většina instrukcí je stejná a jen využívá if, else větvení, proto bych jejich popis podrobně nepopisoval. Ale jsou implementována i zajímavější řešení provedení instrukcí, jako je například instrukce 'CALL', která nejdříve dynamicky zkontroluje label a zavolá funkci 'int\_cycles'. Funkce 'int\_cycles' je pozměněná implementace provádění instrukcí z funkce main, ale s tím, že se zde vyskytuje i čítač zanoření a kontrola 'RETURN' instrukcí. Postup funkce je takový, že se nejdříve zkopíruje původní pole všechn instrukcí a vymažou se z něj instrukce, které mají atribut order menší, jak instrukce label, na kterou se má provést skok.
 - Instrukce 'JUMP' je implementována jen návratovou hodnotou z funkce 'instr\_exec', která má hodnotu rovnou atributu order instrukce label, na který se má skočit.
 - Při návratu z instrukce 'instr\_exec' se kontroluje návratová hodnota, která ve většině případů žádná není, ale může být a to buď s hodnotou end, kterou vrací instrukce 'RETURN' nebo hodnotu atributu order, podle kterého se upraví aktuální seznam instrukcí v seznamu instrukcí. Pokud je návratová hodnota hodnota atributu order, tak se provede změna seznamu instrukcí a to tak, že pokud je hodnota order menší jak hodnota aktuálně prováděné instrukce 'JUMP', tak se doplní do seznamu instrukcí smazané instrukce. Pokud ale je návratová hodnota větší, jak hodnota atributu order aktuálně prováděné instrukce, tak se ze seznamu instrukcí instrukce s menší hodnotou atributu order odstraní.
